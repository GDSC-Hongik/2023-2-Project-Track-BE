# 3장 데이터 모델링과 모델 구현하기

### 데이터 모델링

서비스의 요구와 형식에 맞추어 데이터의 구조와 형식을 정하는 것

DB 시간에 했던 것처럼 개체와 관계를 정해야 하는데, 누가봐도 뻔한 것들은 패스하고, 좋아요와 팔로우를 보자. 이 2개는 개체로 볼 수도 있고, 관계로 볼 수도 있다. 그래서 상황에 따라 다르게 처리해야하는데, **좋아요는 좋아요 누른 리뷰를 모아보고, 가장 최근에 좋아한 리뷰 순으로 정렬하는 기능을 구현할 것이기 때문에 생성시간을 기록할 필요가 있고, 팔로우는 팔로우 누른 리뷰를 모아본다고 해도, 먼저 팔로우한 사람의 게시물을 먼저 보는 것이 아니라, 먼저 올린 게시물을 먼저 보기 때문에 리뷰의 생성 시간만 알면 되므로 팔로우의 생성 시간은 필요없다. 그래서 좋아요는 개체, 팔로우는 관계로 나타냈다**.

![근데 개인적인 생각으로는 속성 하나 밖에 없는데 굳이 개체로 설정해야 되나 싶긴함.](https://prod-files-secure.s3.us-west-2.amazonaws.com/956ff5d2-3ef3-459b-abde-09ddbf04fc0f/ca64e021-feab-46bd-acaa-b9e246aeac64/Untitled.png)

근데 개인적인 생각으로는 속성 하나 밖에 없는데 굳이 개체로 설정해야 되나 싶긴함.

### 일대다 관계

그림에는 안나와있지만, comment 개체는 user,review로부터 각각의 기본키를 외래키로 필요로 한다. 그래서 다음 코드를 보자.

```python
class Comment(models.model):
    content = models.TextField(max_length=500,blank=False)
    dt_created = models.DateTimeField(auto_now_add=True)
    dt_updated = models.DateTimeField(auto_now=True)
    
    author = models.ForeignKey(User,on_delete=models.CASCADE) # 외래키 설정
    
    review = models.ForeignKey(Review,on_delete=models.CASCADE) # 외래키 설정
    
    def __str__(self):
        return self.content[:30] # 내용의 첫 30자만 출력
```

### 일대일 관계

User와 Profile 관계를 생각하면 일대일이고, User가 profile을 가진다고 생각할 수 있기에 profile 부분에 user = OneToOneField(User,on_delete=models.casacade) 와 같이 구현할 수 있다.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/956ff5d2-3ef3-459b-abde-09ddbf04fc0f/79c05a40-59fd-430f-a722-2ccc7115cde3/Untitled.png)

다음과 같이 4번의 과정을 거쳐서 완성해야한다. 개인이 지정한 함수에 대해서는 마이그레이션을 할때와 마이그레이션을 취소할 때 어떻게 해야하는지 Django에게 꼭 알려줘야 실행을 한다.

밑에는 0008 마이그레이션의 코드이다.

```python
from django.db import migrations

def user_to_profile(apps, schema_editor): # 마이그레이션을 할 때
    User = apps.get_model('coplate', 'User')
    Profile = apps.get_model('coplate', 'Profile')
    for user in User.objects.all():
        Profile.objects.create(
            nickname = user.nickname,
            profile_pic = user.profile_pic,
            intro = user.intro,
            user = user,
        )
        

def profile_to_user(apps, schema_editor): # 마이그레이션을 취소할 때
    User = apps.get_model('coplate', 'User')
    Profile = apps.get_model('coplate', 'Profile')
    for profile in Profile.objects.all():
        user = profile.user
        user.nickname = profile.nickname
        user.profile_pic = profile.profile_pic
        user.intro = profile.intro
        user.save()

class Migration(migrations.Migration):

    dependencies = [
        ('coplate', '0007_profile'),
    ]

    operations = [
				# 1번째 인자는 마이그레이션을 할 때, 2번째 인자는 마이그레이션을 취소할 때 실행.
        migrations.RunPython(user_to_profile, profile_to_user),
    ]
```

### 다대다 관계

model.ManyToMany(<to_model>) 구현. 괄호안에는 어느 쪽 모델을 넣어도 무관함. on_delete 옵션도 없다. 다대다 관계에는 대칭 관계와 비대칭 관계가 있는데, 대칭관계는 친구관계, 비대칭관계는 팔로잉이다. (철수가 영희를 팔로우한다고 해서 영희가 철수를 팔로우 하는 것은 아니다)