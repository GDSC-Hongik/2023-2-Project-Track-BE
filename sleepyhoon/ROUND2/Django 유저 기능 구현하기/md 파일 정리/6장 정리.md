# 6장 프로젝트 배포

### 이메일 인증에 대하여

우리가 이메일을 주고 받을 때는 

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/956ff5d2-3ef3-459b-abde-09ddbf04fc0f/bc0230d3-a76b-411c-84fc-6a74106b65b7/Untitled.png)

위와 같은 순서를 거친다

Django를 사용할때는 송신자가 Django를 이용한다는 차이만 존재하는데, 이때는 SMTP 서버를 따로 설정을 해줘야 한다.

자신의 구글 계정에 로그인한 다음, 2단계 인증을 클릭, 그 다음 맨 밑으로 가면 앱 비밀번호를 설정할 수 있는데 그러면 고유의 16자리 비밀번호를 정해줌. 그 비밀번호는 1번 보여주면 다시 오픈하지 않기 때문에 반드시 기억에 둬야함. 나같은 경우에는 카톡에 나에게 보내기로 저장해 두었음.

그 다음 setting.py에 맨 밑에 다음 코드를 추가한다.

```python
# email settings
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = "smtp.gmail.com"
EMAIL_PORT = 587
EMAIL_USE_TLS = True
EMAIL_HOST_USER = "pokjm99@gmail.com" # 내 실제 gmail
EMAIL_HOST_PASSWORD = "<16자리 코드>"
```

## 프로젝트 배포하기

처음에 사이트 배포한 방법과 동일하다고 하는데 잘 기억은 안 난다…ㅎ 그래서 다시 정리한다.

### Production?

- 웹 어플리케이션이 배포되고 실제로 운영되고 있는 상태를 의미한다.
- pythonanywhere를 이용해서 배포했는데 아디 비번 맨날 까먹어서 적어놓는다.

```python
id=jamong
password=승훈***! # 내가 맨날 쓰는 비번
```

무료 계정으로는 한 번에 1개의 웹 사이트만 배포가 가능해서, 기존에 배포 했던 사이트는 없애고, 새로운 사이트로 시작하기로 했다.

배포과정을 정리하기에는 다소 길기 때문에 나중에 설명하도록 하겠다.

### 정적파일 정리

- 로컬에서는 정적파일, 예를 들어 이미지를 출력할 때, url을 따라서 이동하고 그것을 template에서 출력해준다. 하지만 배포 후에는 과정이 조금 다른데, 정적파일은 말 그대로 변하지 않기 때문에, django에 전달할 필요 없이 바로 웹 서버에서 처리해준다.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/956ff5d2-3ef3-459b-abde-09ddbf04fc0f/f9f01df1-c74a-4845-a65f-3093b1af6071/Untitled.png)

서버가 정적파일을 찾을 수 있도록 해주는 것이 중요하다. 

- 정적파일은 크게 2가지로 나뉘는데 정해져 있는 정적 파일과 유저가 업로드 하는 정적 파일로 나뉜다. 맞는 표현은 아니지만 이 강의에서는 전자를 static file, 후자를 media file이라고 하였다. (실제로는 2개 모두 static file이 맞음)
- 그래서 전자는 url이 “/static/” 이 되고, 후자는 “/uploads/” 가 된다.
- 그런데 문제가 생긴다. media file의 경우에는 한 디렉토리안에 모두 모여있는데, static file의 경우에는 여기저기 흩어져 존재한다. 그래서 이들을 한 곳으로 모아주는 것이 필요하다.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/956ff5d2-3ef3-459b-abde-09ddbf04fc0f/ab88e3f4-35d0-4389-a7bb-f15eea4787ca/Untitled.png)

이 명령어를 사용하여 한 곳으로 모아 줄 것이다.

# 아주 중요한 오류가 생겼다.

갑자기 배포가 안되서 뭐가 문제인지 정말 몇시간동안 찾았다…. 그 결과

middleware에서

```python
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'allauth.account.middleware.AccountMiddleware', # 여기가 문제임
    'coplate.middleware.ProfileSetUpMiddleWare',
]
```

저기 부분을 주목하자. 로컬에서 실행할 때는 저게 없으면 안돌아가고, 배포할때는 저거 있으면 안돌아간다. 배포할 때 오류를 보니 allauth.account.middleware를 찾을 수 없다고 뜬다. 왜이러지. allauth 버전을 다르게 하기는 했는데 이게 발목을 잡나? 싶기도 하다. 아무튼 지우니까 배포는 되는데, 또 유저 프로필 이미지는 안나온다. 근데 음식사진은 잘나옴. 이거 안나올거면 다 안나올 것이지 왜 어떤건 되고 어떤건 안되는 건지 모르겠다…일단 내일 하도록 하자. 이거 원인이 로컬 가상환경에서 allauth 버전이랑 배포할때 가상환경에서 allauth 버전이 달라서 생기는 원인 같다. 그래서 로컬이랑 같은 버전으로 배포의 가상환경에서 다운로드 하려고 했는데 이게 뭐야. 해당되는 버전이 없다네? 이건 그냥 이슈라고 생각하고 넘어가자.