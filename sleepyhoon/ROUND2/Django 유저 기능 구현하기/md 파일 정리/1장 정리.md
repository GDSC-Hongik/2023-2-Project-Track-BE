# 1장 유저 기능과 django-allauth

## Django.contrib.auth && Django.allauth

- 유저 기능을 구현할 때 사용되는 장고에 구현된 앱, 기본적으로 설치되어 있다.
- 다른 앱들과 마찬가지로 form,model,urls,views 가 포함되어 있음
- 기본 유저 모델도 제공해주고(User), 상속받아서 쓸 수 있는 유저모델(AbstractUser, AbstractBaseUser)도 제공해준다. 기본 유저 모델은 권장x
    - AbstractUser : 기본적으로 쓸만한 필드들 다 있음 → 이번 수업에서 사용
    - AbstractBaseUser : 부가적인 필드들 존재(이게 맞는 표현인지는 모르겠다)

but, 이번 강의에서는 Django.allauth를 사용할 것이다. 정확히 말하면, 

<aside>
💡 **우리가 만들려는 프로젝트의 model은 Django.contrib.auth를 이용해서 만들 것이고, 나머지 form,urls,views는 Django.allauth를 통해서 만들것이다.**

</aside>

왜냐면 Django.allauth는 소셜로그인도 지원하고, 이미 완성된 기능들이 많기 때문에 좀 더 코드 짜기가 쉽기 때문에 쓸 것이다. 

- allauth를 사용하던 와중에 여러 404 에러가 발생하여 확인해보니 버전 차이가 나서 그렇다고 한다. 불만있으면 0.4.4 버전을 다운로드 하라는데 … 일단 진행하자. 이게 127.0.0.1로 실행하는 것이 아니라 localhost:8000로 진행을 해야 오류가 없는거 같다.
- allauth로 환경 설정을 모두 마무리하면  [localhost:8000/signup](http://localhost:8000/signup으로) 으로 가서 회원가입이 가능한데, 이는 기본적으로 제공해주는 url인거 같다. 따로 urls.py에 추가하지 않아도 돌아가는 모습.

---

## 회원가입 및 로그인, 로그아웃

- 회원가입이 완료되면 accounts/profile url로 이동하게 되는데 이는 정의되지 않아서 오류가 남. 하지만 회원가입은 된 것이다.
- allauth에서 user에 대한 접근은 request.user로 접근 가능하며 user관련 정보도 접근 가능

> ex) [request.user.email](http://request.user.email) 같은 경우 email에 접근 가능하게 한다. 확인하려면 print사용. 터미널에 나옴
> 
- 기본적으로 https://github.com/pennersr/django-allauth/blob/main/allauth/account/urls.py 링크를 따라 가보면 urls.py 안에 여러 name들이 있어서 간단하게 이름만 사용해서 사용할 수 있다.

```python
ACCOUNT_SIGNUP_REDIRECT_URL = "index" # 사용자가 회원가입 후 이동할 url
LOGIN_REDIRECT_URL = 'index' # 사용자가 로그인 후 이동할 url
ACCOUNT_LOGOUT_ON_GET = True # 로그아웃 누르면 바로 로그아웃
ACCOUNT_AUTHENTICATION_METHOD = 'email' # 회원가입 시 아이디 뭐로 할거? email
ACCOUNT_EMAIL_REQUIRED = True # 이메일 입력 칸 만듬
ACCOUNT_USERNAME_REQUIRED = False # username 입력 칸 없애기
```

```python
class User(AbstractUser):
    def __str__(self):
        return self.email
```

이렇게 하면 로그인/회원가입을 할 때 이메일을 입력하도록 하는데, 그렇다고 해서 username field가 null인 것은 아니다. 보통은 email @ 앞에 오는 문자열을 username으로 인식한다. 

### 로그인이 일어나면 서버에서 생기는 일

1. session이 발생한다. session은 웹 페이지 방문에 대한 기록인데, 각각의 session은 session id로 구분한다. 그리고 서버는 클라이언트에게 쿠키에 session id를 담아서 두는데, 그렇게 되면 클라이언트는 매번 로그인 할 필요없이 서버에서 session id만 주게 되면 로그인이 되서 편리하게 사용할 수 있다.
2. 쿠키는 영원히 존재하는게 아니라 지속시간이 존재하는데, 기본은 2주이고 우리가 따로 코드로 지정해줄 수도 있음

```python
ACCOUNT_SESSION_REMEMBER = True # user 기억하기
```

1. session의 경우 유저가 직접 logout 버튼을 누른 경우에는 서버에 있는 session이 없어지지만 지속시간이 다해서 유저의 쿠키가 소멸한 경우에는 서버에 남아있게 된다. 그래서 주기적으로 만료된 세션들을 정리해주는 것이 필요하다.